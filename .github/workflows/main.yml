name: Build 3DS Manual

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkitarm:latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build the 3DSX
        run: |
          # 1. Load the environment (using '.' for shell compatibility)
          . /opt/devkitpro/3dsvars.sh

          # 2. Compile the C++ code into an ELF
          $DEVKITARM/bin/arm-none-eabi-g++ -O2 -mword-relocations \
          -fomit-frame-pointer -ffunction-sections \
          -march=armv6k -mtune=mpcore -mfloat-abi=hard -mtp=soft \
          -specs=3dsx.specs \
          -I$DEVKITPRO/libctru/include \
          source/main.cpp \
          -L$DEVKITPRO/libctru/lib -lctru -lm \
          -o FragranceMaker.elf

          # 3. Create the SMDH metadata (The "App Info" file)
          # We use the internal default icon so it doesn't fail on missing assets
          $DEVKITPRO/tools/bin/smdhtool --create "Fragrance Maker" "The Fragrance Planner" "Homebrew" /opt/devkitpro/libctru/default_icon.png FragranceMaker.smdh

          # 4. Final conversion to 3DSX
          $DEVKITPRO/tools/bin/3dsxtool FragranceMaker.elf FragranceMaker.3dsx --romfs=romfs --smdh=FragranceMaker.smdh

      - name: Upload Finished App
        uses: actions/upload-artifact@v4
        with:
          name: 3DS-Homebrew-Build
          path: FragranceMaker.3dsx
